name: CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  REGISTRY_DOMAIN: registry.benedicttiong.site
  IMAGE_NAME: test-service
  API_HOST: controller.benedicttiong.site
  DEVICE_ID: "test-1"
  BLUE_IP: "192.168.3.100"
  GREEN_IP: "192.168.3.101"

jobs:
  CI-Pipeline:
    name: 1. CI-Pipeline
    runs-on: ubuntu-latest
    outputs:
      IMAGE_URL: ${{ steps.meta.outputs.IMAGE_URL }}
      VERSION: ${{ steps.meta.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - id: meta
        run: |
          VERSION=$(date +%Y%m%d)-$(git rev-parse --short HEAD)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "IMAGE_URL=${{ env.REGISTRY_DOMAIN }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
      - uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.IMAGE_URL }}:${{ steps.meta.outputs.VERSION }}
          provenance: false

  CD-Pipeline:
    name: 2. CD-Pipeline
    needs: CI-Pipeline
    runs-on: ubuntu-latest
    steps:
      - name: Get Auth Token
        id: auth
        run: |
          set -o pipefail
          TEMP_TOKEN=$(curl --location --request PUT 'https://controller.benedicttiong.site/api/auth/login' \
            --header 'Content-Type: application/json' --fail --silent \
            --data-raw '{"email": "test@gmail.com", "password": "test"}' | tr -d '"')
          if [ -z "$TEMP_TOKEN" ]; then echo "::error::Auth token is empty."; exit 1; fi
          echo "::add-mask::$TEMP_TOKEN"
          echo "TOKEN=$TEMP_TOKEN" >> $GITHUB_ENV

      # --- 步驟 1: 找出目前正在服務的 Blue 版本 (如果存在) ---
      - name: Find Active Blue Version
        id: find_blue
        run: |
          # (保持你目前的假設)
          echo "BLUE_INSTANCE_PATH=Device.LCM.LXC.1." >> $GITHUB_ENV
          echo "Assuming Blue instance is Device.LCM.LXC.1."
          
      # --- 步驟 2: 安裝新的 Green 版本 ---
      - name: Install New Version (Green)
        id: install_green
        run: |
          IMAGE_URL_WITH_PREFIX="docker://${{ needs.CI-Pipeline.outputs.IMAGE_URL }}:${{ needs.CI-Pipeline.outputs.VERSION }}"
          ALIAS="green-${{ needs.CI-Pipeline.outputs.VERSION }}"
          
          echo "Triggering installation for $ALIAS..."
          RESPONSE=$(curl --location --request PUT 'https://controller.benedicttiong.site/api/device/${{ env.DEVICE_ID }}/stomp/add' \
            --header 'Content-Type: application/json' --header "Authorization: ${TOKEN}" \
            --fail --silent --connect-timeout 10 --max-time 60 \
            --data-raw "{\"allow_partial\": true, \"create_objs\": [{\"obj_path\": \"Device.LCM.LXC.\", \"param_settings\": [{\"param\": \"Alias\", \"value\": \"$ALIAS\"}, {\"param\": \"ImageURL\", \"value\": \"$IMAGE_URL_WITH_PREFIX\"}]}]}")
          
          if [[ "$RESPONSE" != *"OperSuccess"* ]]; then
            echo "::error::Install failed. Response: $RESPONSE"
            exit 1
          fi
          
          echo "Installation triggered. Waiting 30s for container to start..."
          # 這裡的 sleep 仍然是必要的，你需要等容器啟動並取得 IP
          # 你可以增加這個時間，如果 30 秒不夠
          sleep 30

      # --- 步驟 3: (新) 獲取新 Green 版本的 IP ---
      - name: Find Green IP Address
        id: find_green_ip
        run: |
          VERSION_TAG="${{ needs.CI-Pipeline.outputs.VERSION }}"
          echo "Finding IP for VersionTag: $VERSION_TAG"
          
          # 呼叫你修改過的 FindIPsByVersion()
          # 增加 timeout 時間 (max-time 60) 來等待 C code 同步執行完成
          RESPONSE=$(curl --location --request PUT 'https://controller.benedicttiong.site/api/device/${{ env.DEVICE_ID }}/stomp/operate' \
            --header 'Content-Type: application/json' --header "Authorization: ${TOKEN}" \
            --fail --silent --connect-timeout 20 --max-time 60 \
            --data-raw "{\"command\": \"Device.DeploymentManager.FindIPsByVersion()\", \"input_args\": { \"VersionTag\": \"$VERSION_TAG\" }}")
          
          echo "API Response: $RESPONSE"
          
          # 檢查 API 呼叫是否成功
          if [[ "$RESPONSE" != *"output_args"* ]]; then
            echo "::error::FindIPsByVersion API call failed or did not return output_args. Response: $RESPONSE"
            exit 1
          fi
          
          # (新) 使用 jq 從 JSON 回應中解析 IP
          GREEN_IP=$(echo "$RESPONSE" | jq -r '.output_args.FoundIP')
          
          if [ -z "$GREEN_IP" ] || [ "$GREEN_IP" == "null" ] || [[ "$GREEN_IP" == *"No "* ]]; then
            echo "::error::Could not parse Green IP from response. IP: '$GREEN_IP'"
            echo "Full response: $RESPONSE"
            exit 1
          fi
          
          echo "Found Green IP: $GREEN_IP"
          # (新) 將 IP 存入環境變數，供下一步使用
          echo "GREEN_IP=$GREEN_IP" >> $GITHUB_ENV

      # --- 步驟 4: (修改) 切換流量到 Green 版本 ---
      - name: Switch Traffic to Green
        id: switch_traffic
        # (新) 讀取上一步存的環境變數
        env:
          GREEN_IP: ${{ env.GREEN_IP }}
        run: |
          if [ -z "$GREEN_IP" ]; then
            echo "::error::GREEN_IP variable is not set."
            exit 1
          fi
          
          echo "Switching traffic to $GREEN_IP"
          # (新) 使用 $GREEN_IP 變數，而不是硬式編碼
          RESPONSE=$(curl --location --request PUT 'https://controller.benedicttiong.site/api/device/${{ env.DEVICE_ID }}/stomp/operate' \
            --header 'Content-Type: application/json' --header "Authorization: ${TOKEN}" \
            --fail --silent --connect-timeout 10 --max-time 30 \
            --data-raw "{\"command\": \"Device.DeploymentManager.SwitchActiveVersion()\", \"input_args\": { \"target_ip\": \"$GREEN_IP\" }}")
          
          CURL_EXIT_CODE=$?
          if [ $CURL_EXIT_CODE -ne 0 ]; then
            echo "::error::Switch traffic API call failed (Exit code: $CURL_EXIT_CODE). Response: $RESPONSE"
            exit 1
          fi
          echo "Traffic switched successfully."

      # --- 步驟 5: 清理舊的 Blue 版本 ---
      - name: Clean Up Old Version (Blue)
        if: always() 
        run: |
          OLD_INSTANCE_PATH="${{ env.BLUE_INSTANCE_PATH }}"
          if [ -z "$OLD_INSTANCE_PATH" ]; then
            echo "No old Blue instance path found. Skipping cleanup."
          else
            echo "Cleaning up old Blue instance: $OLD_INSTANCE_PATH"
            curl --location --request PUT 'https://controller.benedicttiong.site/api/device/${{ env.DEVICE_ID }}/stomp/del' \
              --header 'Content-Type: application/json' --header "Authorization: ${TOKEN}" \
              --silent --connect-timeout 10 --max-time 30 \
              --data-raw "{\"allow_partial\": true, \"obj_paths\": [\"$OLD_INSTANCE_PATH\"]}"
          fi