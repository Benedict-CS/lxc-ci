name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY_DOMAIN: registry.benedicttiong.site
  IMAGE_NAME: test-service
  API_HOST: controller.benedicttiong.site
  CONTROLLER_DEVICE_ID: "Root-AP"

jobs:
  # --- Job 1: Build & Push ---
  CI-Pipeline:
    name: 1. Build & Push
    runs-on: ubuntu-latest
    outputs:
      IMAGE_URL: ${{ steps.meta.outputs.IMAGE_URL }}
      VERSION: ${{ steps.meta.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - id: meta
        run: |
          VERSION=$(date +%Y%m%d)-$(git rev-parse --short HEAD)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "IMAGE_URL=${{ env.REGISTRY_DOMAIN }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
      
      - uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.IMAGE_URL }}:${{ steps.meta.outputs.VERSION }}
          provenance: false

  # --- Job 2: Trigger Deployment ---
  CD-Pipeline:
    name: 2. Trigger Deployment
    needs: [CI-Pipeline]
    runs-on: ubuntu-latest
    steps:
      - name: Get Auth Token
        id: auth
        run: |
          TEMP_TOKEN=$(curl --location --request PUT 'https://${{ env.API_HOST }}/api/auth/login' \
            --header 'Content-Type: application/json' --fail --silent \
            --data-raw '{"email": "test@gmail.com", "password": "test"}' | tr -d '"')
          echo "::add-mask::$TEMP_TOKEN"
          echo "TOKEN=$TEMP_TOKEN" >> $GITHUB_ENV

      # 步驟 1: 發送安裝指令
# 步驟 1: 發送安裝指令 (使用 AddObject 確保實例被建立)
      - name: 1. Trigger Install (Root + Extenders)
        id: deploy
        run: |
          FULL_IMAGE_URL="docker://${{ needs.CI-Pipeline.outputs.IMAGE_URL }}:${{ needs.CI-Pipeline.outputs.VERSION }}"
          echo "Deploying Image: $FULL_IMAGE_URL"

          # 使用 stomp/add，這樣就算 DB 是空的也能自動建立並觸發安裝
          curl --location --request PUT "https://${{ env.API_HOST }}/api/device/Root-AP/stomp/add" \
            --header 'Content-Type: application/json' \
            --header "Authorization: ${TOKEN}" \
            --silent --show-error \
            --data-raw "{
                \"allow_partial\": true, 
                \"create_objs\": [{
                    \"obj_path\": \"Device.LCM.LXC.\", 
                    \"param_settings\": [{
                        \"param\": \"ImageURL\", 
                        \"value\": \"$FULL_IMAGE_URL\"
                    }]
                }]
            }" || true
          
          echo "✅ AddObject sent. This triggers the installation. Waiting 40s..."
          sleep 10

      # 步驟 2: 掃描新容器 IP (產生列表)
      - name: 2. Refresh IP List (Find IPs)
        run: |
          VERSION_TAG="${{ needs.CI-Pipeline.outputs.VERSION }}"
          echo "Scanning for containers with version: $VERSION_TAG"
          
          # 呼叫 Agent 去掃描 ubus 並產生 /tmp/ben/new_ips.txt
          curl --location --request PUT "https://${{ env.API_HOST }}/api/device/Root-AP/stomp/operate" \
            --header 'Content-Type: application/json' \
            --header "Authorization: ${TOKEN}" \
            --silent --show-error \
            --data-raw "{
                \"command\": \"Device.DeploymentManager.FindIPsByVersion()\", 
                \"input_args\": { \"VersionTag\": \"$VERSION_TAG\" }
            }" || true
            
          echo "✅ IP Scan triggered. Waiting 5s for file generation..."
          sleep 5

      # 步驟 3: 設定分流規則 (讀取列表並生效)
      - name: 3. Apply Canary Split (Update VIP)
        run: |
          echo "Updating IPTables for VIP..."
          
          curl --location --request PUT "https://${{ env.API_HOST }}/api/device/Root-AP/stomp/operate" \
            --header 'Content-Type: application/json' \
            --header "Authorization: ${TOKEN}" \
            --silent --show-error \
            --data-raw "{
                \"command\": \"Device.DeploymentManager.SetCanarySplit()\", 
                \"input_args\": {
                    \"old_weight\": \"0\",
                    \"new_weight\": \"100\"
                }
            }" || true

          echo "✅ Canary Split Updated. VIP 192.168.3.1 should now point to new containers."    